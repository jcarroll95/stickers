# C4 Architecture Diagrams

This document describes the Stickerboards architecture using the C4 model.

Levels included:
- Level 1 — System Context
- Level 2 — Container Diagram
- Level 3 — Component Diagram (API)

---

# Level 1 — System Context

```mermaid
C4Context
title Stickerboards - System Context

Person(user, "User", "GLP-1 user logging doses and collecting stickers")
Person(admin, "Admin", "Manages sticker packs and inventory")

System(stickerboards, "Stickerboards", "Social stickerboard application")

System_Ext(github, "GitHub", "CI/CD pipelines")
System_Ext(grafana, "Grafana + Loki", "Monitoring and log aggregation")
System_Ext(spaces, "DigitalOcean Spaces", "Database backups")
System_Ext(sentry, "Sentry", "Error tracking (in progress)")

Rel(user, stickerboards, "Uses via browser")
Rel(admin, stickerboards, "Administers via browser")

Rel(stickerboards, github, "Deploys via CI/CD")
Rel(stickerboards, grafana, "Sends logs")
Rel(stickerboards, spaces, "Stores backups")
Rel(stickerboards, sentry, "Sends errors")
```

# Level 2 — Container Diagram

```mermaid
C4Container
title Stickerboards - Container Diagram

Person(user, "User")
Person(admin, "Admin")

System_Boundary(stickerboards, "Stickerboards") {

  Container(web, "Web App", "React + Vite", "SPA with Konva-based sticker board UI")

  Container(api, "API", "Node.js + Express", "REST API implementing business logic")

  ContainerDb(db, "MongoDB", "MongoDB Atlas / Managed Mongo", "Primary data store")

}

System_Ext(grafana, "Grafana + Loki", "Observability stack")
System_Ext(spaces, "DigitalOcean Spaces", "Backup object storage")
System_Ext(sentry, "Sentry", "Error tracking")

Rel(user, web, "Uses", "HTTPS")
Rel(admin, web, "Uses", "HTTPS")

Rel(web, api, "Calls", "REST/JSON over HTTPS")
Rel(api, db, "Reads/Writes", "Mongoose")

Rel(api, grafana, "Emits logs")
Rel(api, sentry, "Reports errors")
Rel(api, spaces, "Uploads backups")
```

# Level 3 — Component Diagram (API)

```mermaid
C4Component
title Stickerboards API - Component Diagram

Container(api, "Stickerboards API", "Node.js + Express")

Component(controllers, "Controllers", "Express Route Handlers", "Transport layer, input validation")
Component(middleware, "Middleware", "Express Middleware", "Auth, RBAC, rate limiting, sanitization")
Component(usecases, "Usecases", "Application Layer", "Business logic and transactional rules")
Component(models, "Mongoose Models", "Persistence Adapter", "Schema validation and DB access")
Component(audit, "Audit Logger", "Service", "Structured audit event emission")
Component(logging, "Structured Logger", "Service", "Application logging")

ContainerDb(db, "MongoDB", "Database")

Rel(controllers, middleware, "Passes through")
Rel(middleware, usecases, "Invokes")
Rel(usecases, models, "Reads/Writes")
Rel(usecases, audit, "Emits events")
Rel(usecases, logging, "Emits logs")
Rel(models, db, "Persists data")

```

** Architectural Notes **

## Invariant Enforcement Layer

Core invariants are enforced inside usecases, including:
-Idempotent sticker transactions (opId)
-MongoDB transactional boundaries
-RBAC enforcement
-Audit emission guarantees
Controllers remain thin and contain no domain logic.

## Known Architectural Tradeoff
Usecases currently import Mongoose models directly.

A strict Hexagonal Architecture would introduce:
-Repository Ports
-Infrastructure Adapters
-Framework-agnostic Domain Entities
This is a known and documented evolution path.

## Future Diagram Extensions
Potential additions:
-Sequence Diagram: Award Sticker Transaction
-Sequence Diagram: Asset Ingestion
-Deployment Diagram (CI → Artifact → PM2)
-Hexagonal Target-State Diagram
